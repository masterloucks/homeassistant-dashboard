<div class="dashboard-wrapper">

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner diameter="60"></mat-spinner>
    <p>Loading dashboard...</p>
  </div>

  <!-- Dashboard Content -->
  <div *ngIf="!loading && dashboardState" class="dashboard-content">
    
    <!-- Above The Fold Section -->
    <div class="above-fold-section">
      
      <!-- Critical Status Summary (Top Left) -->
      <div class="critical-status-section">
        <div class="status-summary-card">
          <mat-icon class="status-icon">{{ getDoorSecurityIcon() }}</mat-icon>
          <div class="status-info">
            <h3 class="status-title">{{ getDoorSecurityTitle() }}</h3>
            <p class="status-text">{{ getDoorSecuritySummary() }}</p>
          </div>
        </div>
        
        <div class="status-summary-card">
          <mat-icon class="status-icon">{{ getSecurityAlertsIcon() }}</mat-icon>
          <div class="status-info">
            <h3 class="status-title">Security</h3>
            <p class="status-text">{{ dashboardState.security.summary }}</p>
          </div>
        </div>
      </div>
      
      <!-- Camera Grid (Top Right) -->
      <div class="camera-section">
        <app-camera-grid></app-camera-grid>
      </div>
      
    </div>
    
    <!-- Summary Cards -->
    <div class="summary-section">
      <div *ngFor="let group of [
        dashboardState.doors,
        dashboardState.lights,
        dashboardState.security,
        dashboardState.climate,
        dashboardState.media
      ]" class="summary-card" [class.all-ok]="group.allOk" [class.attention-needed]="!group.allOk">
        <div class="summary-header">
          <mat-icon class="summary-icon">{{ getSummaryIcon(group.category) }}</mat-icon>
          <div class="summary-info">
            <h3 class="summary-title">{{ group.category }}</h3>
            <p class="summary-text">{{ group.summary }}</p>
            <div *ngIf="group.allOk" class="quiet-indicator">
              <mat-icon class="quiet-icon">check_circle_outline</mat-icon>
              <span class="quiet-text">All Quiet since {{ getLastActivityTime(group) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Individual Device Cards (Only when attention needed) -->
    <div class="devices-section">
      
      <!-- Doors -->
      <div *ngIf="getVisibleDevices(dashboardState.doors).length > 0" class="device-category">
        <h2 class="category-title">
          <mat-icon>door_front</mat-icon>
          Open Doors
        </h2>
        <div class="device-grid">
          <app-device-card
            *ngFor="let device of getVisibleDevices(dashboardState.doors)"
            [device]="device"
            [icon]="getDeviceIcon(device)"
            [clickable]="isClickableDevice(device)"
            (deviceClick)="onDeviceClick($event)">
          </app-device-card>
        </div>
      </div>

      <!-- Lights -->
      <div *ngIf="getVisibleDevices(dashboardState.lights).length > 0" class="device-category">
        <h2 class="category-title">
          <mat-icon>lightbulb</mat-icon>
          Active Lights
        </h2>
        <div class="device-grid">
          <app-device-card
            *ngFor="let device of getVisibleDevices(dashboardState.lights)"
            [device]="device"
            [icon]="getDeviceIcon(device)"
            [clickable]="isClickableDevice(device)"
            (deviceClick)="onDeviceClick($event)">
          </app-device-card>
        </div>
      </div>

      <!-- Security -->
      <div *ngIf="getVisibleDevices(dashboardState.security).length > 0" class="device-category">
        <h2 class="category-title">
          <mat-icon>security</mat-icon>
          Security Alerts
        </h2>
        <div class="device-grid">
          <app-device-card
            *ngFor="let device of getVisibleDevices(dashboardState.security)"
            [device]="device"
            [icon]="getDeviceIcon(device)"
            [clickable]="isClickableDevice(device)"
            (deviceClick)="onDeviceClick($event)">
          </app-device-card>
        </div>
      </div>

      <!-- Climate (Always show some climate info) -->
      <div *ngIf="dashboardState.climate" class="device-category">
        <h2 class="category-title">
          <mat-icon>thermostat</mat-icon>
          Climate
        </h2>
        <div class="device-grid">
          <app-device-card
            *ngFor="let device of dashboardState.climate.devices.slice(0, 4)"
            [device]="device"
            [icon]="getDeviceIcon(device)"
            [clickable]="isClickableDevice(device)"
            (deviceClick)="onDeviceClick($event)">
          </app-device-card>
        </div>
      </div>

      <!-- Active Media Players -->
      <div *ngIf="getVisibleDevices(dashboardState.media).length > 0" class="device-category">
        <h2 class="category-title">
          <mat-icon>play_circle</mat-icon>
          Active Media
        </h2>
        <div class="device-grid">
          <app-device-card
            *ngFor="let device of getVisibleDevices(dashboardState.media)"
            [device]="device"
            [icon]="getDeviceIcon(device)"
            [clickable]="isClickableDevice(device)"
            (deviceClick)="onDeviceClick($event)">
          </app-device-card>
        </div>
      </div>

    </div>

    <!-- All Clear State -->
    <div *ngIf="dashboardState.doors.allOk && 
                dashboardState.lights.allOk && 
                dashboardState.security.allOk &&
                getVisibleDevices(dashboardState.media).length === 0" 
         class="all-clear">
      <mat-icon class="all-clear-icon">check_circle</mat-icon>
      <h2>All Systems Normal</h2>
      <p>Your home is secure and all devices are in their expected states.</p>
    </div>

  </div>

  <!-- Error State -->
  <div *ngIf="!loading && !dashboardState && !connected" class="error-state">
    <mat-icon class="error-icon">error_outline</mat-icon>
    <h2>Unable to Connect</h2>
    <p>Cannot connect to Home Assistant. Please check your connection.</p>
    <button mat-raised-button color="primary" (click)="ngOnInit()">
      <mat-icon>refresh</mat-icon>
      Retry Connection
    </button>
  </div>

  <!-- Dashboard Footer -->
  <div class="dashboard-footer">
    <div class="footer-content">
      <div class="device-stats" (click)="onDeviceCountClick()">
        <mat-icon>devices</mat-icon>
        <span class="device-count">{{ getDeviceCount() }} devices</span>
        <span class="last-update">Last update: {{ getLastUpdateTime() }}</span>
      </div>
      <div class="connection-info">
        <mat-icon [class.status-ok]="connected" [class.status-error]="!connected">
          {{ connected ? 'cloud_done' : 'cloud_off' }}
        </mat-icon>
        <span class="connection-text">Backend {{ connected ? 'Connected' : 'Disconnected' }}</span>
      </div>
    </div>
  </div>

</div>